(()=>{"use strict";class e{constructor({element:e},t,s){this.id=e.id,this.type=e.type,this.label=e.label,this.body=e.body,this.attach=e.attach,this.date=t,this.highlight=s}formation(){const e=document.createElement("div");e.className="message",e.id=this.id,this.checkLink(),this.body=this.checkHighlight();const t=this.determineLabel();return e.innerHTML=`\n    <header class="msg-info">\n      <span class="avatar"></span>\n      <h3 class="autor">Chaos Organizer</h3>\n      <time class="time">${this.date}</time>\n    </header>${t}\n      <text class="text">${this.body}</text>\n    </div>`,e}attachFormation(){const e=document.createElement("div");e.className="message",e.id=this.id;const t=this.determineLabel(),s=this.determinePreview();return e.innerHTML=`\n    <header class="msg-info">\n      <span class="avatar"></span>\n      <h3 class="autor">Chaos Organizer</h3>\n      <time class="time">${this.date}</time>\n    </header>${t}\n      <div class="attachWrapper">\n        ${s}\n        <div class="nameplate">\n          <text class="attachName">${this.attach.name}</text>\n          <text class="attachSize">${this.attach.size}Mb</text>\n        </div>\n      </div>\n    </div>`,e}determinePreview(){let e;return"img"===this.type?e=`\n      <a class="link img-link" href=${this.attach.data} rel="noopener" download=${this.attach.name}>\n      <img class="attachment" src=${this.attach.data}></img>\n      </a>`:"video"===this.type?e=`\n      <a class="link vid-link" href=${this.attach.data} rel="noopener" download=${this.attach.name}>\n      <video class="attachment" src=${this.attach.data}></video>\n      <span class="overlay"></span>\n      </a>`:"audio"===this.type&&(e=`\n      <a class="link audio-link" href=${this.attach.data} rel="noopener" download=${this.attach.name}>\n      <span class="audio-overlay"></span>\n      </a>`),e}determineLabel(){let e;switch(this.label){case"imp":return e='<div class="msg-body has-label label-imp" id="imp">',e;case"later":return e='<div class="msg-body has-label label-later" id="later">',e;case"done":return e='<div class="msg-body has-label label-done" id="done">',e;default:e='<div class="msg-body" id="none">'}return e}checkLink(){"links"===this.type&&(this.body=`<a href='${this.body}' target="_blank" rel="noopener noreferrer">${this.body}</a>`)}checkHighlight(){let e;if(!this.highlight)return this.body;if("links"===this.type)return e=`<span class="highlight">${this.body}</span>`,e;const t=new RegExp(this.highlight,"gi");return e=this.body.replaceAll(t,'<span class="highlight">$&</span>'),e}}class t{constructor(){this.all=0,this.text=0,this.audio=0,this.video=0,this.links=0,this.img=0,this.none=0,this.imp=0,this.later=0,this.done=0,this.state="all"}static getDate(e){const t=new Date(e),s=t.getFullYear().toString().slice(-2),a=JSON.stringify(t.getMonth()+1).padStart(2,0);return`${JSON.stringify(t.getDate()).padStart(2,0)}.${a}.${s} ${JSON.stringify(t.getHours()).padStart(2,0)}:${JSON.stringify(t.getMinutes()).padStart(2,0)}`}renderMessage({element:s},a,i,n){const l=t.getDate(s.date),r=new e({element:s},l,i);let o;o="text"===s.type||"links"===s.type||"command"===s.type?r.formation():r.attachFormation(),a.appendChild(o),n||this.msgCount(s.type,s.label)}msgCount(e,t){"command"!==e&&(this.all+=1),void 0!==e&&(this[e]+=1),void 0!==t&&(this[t]+=1)}}class s{constructor(e,t){this.url=e,this.websocket=new WebSocket(t)}load(e){(async e=>{const t=fetch(e.url,{method:e.method}),s=await t;if(!s.ok){const t=await s.text();e.callback(!1,t)}const a=await s.json();e.callback(!0,a)})({url:`${this.url}/archive`,method:"GET",callback:(t,s)=>{t?e(null,s):alert("Ошибка!")}})}sendMessage(e,t,s){const a={type:"command"===t?"command":"send",msg:{type:t,label:"none",body:"command"===t?e.slice(7):e,attach:s,date:Date.now()}};this.websocket.send(JSON.stringify(a))}searchMessage(e){const t={type:"search",msg:e};this.websocket.send(JSON.stringify(t))}filterMessage(e){const t={type:"filter",value:e};this.websocket.send(JSON.stringify(t))}changeLabel(e,t){const s={type:"changeLabel",label:e,targetID:t};this.websocket.send(JSON.stringify(s))}}class a{constructor(){this.element=document.createElement("div"),this.element.className="attachWindow",this.element.innerHTML=a.formation()}static formation(){return'\n      <span class="close"></span>\n      <div class="dropWindow">\n         <span class="dropMessage">Перенесите ваш файл сюда</span>\n         <span class="or">или</span>\n         <div class="inputWrapper">\n            <input class="fileInput" type="file" accept="image/*, audio/*, video/*">\n            <label for="fileInput" class="overlap">Выберите файл</label>\n         </div>\n      </div>'}addHooks(){this.inputBtn=this.element.querySelector(".inputWrapper"),this.overlapped=this.inputBtn.querySelector(".fileInput")}}class i{constructor(){this.reader=new FileReader}read(e,t){let{name:s}=e;e.name.length>20&&(s=`${e.name.slice(0,20)}...`);const a=(e.size/1048576).toFixed(2);let n;this.reader.onload=l=>{n=l.target.result;const r={name:s,type:e.type,size:a,data:n},o=i.determineFileType(e.type);t(r,o)},this.reader.readAsDataURL(e)}static determineFileType(e){let t="text";return e.includes("image")?t="img":e.includes("audio")?t="audio":e.includes("video")&&(t="video"),t}}class n{constructor(){this.element=document.createElement("div"),this.element.className="labelWindow",this.element.innerHTML=n.formation()}static formation(){return'\n      <span class="labelBtn label none" id="none"></span>\n      <span class="labelBtn label important" id="imp"></span>\n      <span class="labelBtn label later" id="later"></span>\n      <span class="labelBtn label done" id="done"></span>\n      '}}class l{constructor(e){this.bindToDOM(e),this.view=new t,this.fileView=new i,this.api=new s("https://organizer-9u9x.onrender.com","wss://organizer-9u9x.onrender.com/ws"),this.labelMenuOut=!1}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e,this.area=this.container.querySelector(".messages"),this.counters=Array.from(this.container.querySelectorAll(".counter"))}init(){this.api.websocket.addEventListener("message",(e=>{const t=JSON.parse(e.data);if(t&&!t.operation){const e=t;"all"!==this.view.state?(this.view.state="all",this.area.innerHTML="",this.loadState("filter")):(this.view.renderMessage({element:e},this.area),this.addCount()),this.scrollDown()}else t&&t.operation&&(this.area.innerHTML="",t.arr.forEach((e=>{this.view.renderMessage({element:e},this.area,t.value,t.operation)})),this.scrollDown())})),this.loadState(),this.registerEvents(),this.addCount()}scrollDown(){this.area.scrollTop=this.area.scrollHeight}registerEvents(){const e=this.container.querySelector(".msg-input"),t=this.container.querySelector(".search"),s=this.container.querySelector(".attach"),a=this.container.querySelector(".categories");e.addEventListener("keypress",(t=>this.textInput(e,t,"msg"))),t.oninput=e=>this.textInput(t,e,"srch"),s.addEventListener("click",(()=>this.showPanel())),a.addEventListener("click",(e=>this.sidePanelEvent(e))),this.area.addEventListener("click",(e=>this.msgClick(e)))}textInput(e,t,s){if("msg"===s&&"Enter"===t.key&&e.value){t.preventDefault();const s=l.determineType(e.value);this.api.sendMessage(e.value,s),e.value=""}else"srch"===s&&e.value?this.api.searchMessage(e.value):"srch"!==s||e.value||(this.area.innerHTML="",this.loadState())}sidePanelEvent(e){const t=e.target.id;this.api.filterMessage(t),this.view.state=t}msgClick(e){let{target:t}=e;if("labelWindow"!==e.target.className&&this.labelMenuOut)return this.labelPanel.element.remove(),this.labelPanel=null,void(this.labelMenuOut=!1);"msg-info"===e.target.className||"msg-body"===e.target.className?t=e.target.parentElement:"msg-info"!==e.target.parentElement&&"msg-body"!==e.target.className||(t=e.target.parentElement.parentElement),this.labelPanel=new n,t.appendChild(this.labelPanel.element),this.labelPanel.element.addEventListener("click",(e=>this.hookClick(e,t))),this.labelMenuOut=!0}hookClick(e,t){console.log(e.target.id,t);const s=t.querySelector(".msg-body");s.className.includes(`label-${e.target.id}`)?console.log("has already"):(this.api.changeLabel(e.target.id,t.id),console.log(s.className),"none"===e.target.id?(s.className="msg-body",this.view.none+=1,this.view[s.id]=Math.max(0,this.view[s.id]-1)):(s.className=`msg-body has-label label-${e.target.id}`,"none"===s.id?this.view.none=Math.max(0,this.view.none-1):this.view[s.id]=Math.max(0,this.view[s.id]-1),this.view[e.target.id]+=1),this.addCount())}static determineType(e){let t="text";return/(https?:\/\/[^\s]+)/.test(e)&&(t="links"),e.includes("@chaos")&&(t="command"),t}loadState(e){this.api.load(((t,s)=>{if(t)return void console.log(t);let a;if("filter"===e&&(a=s.messages.pop()),s.messages.forEach((t=>{this.view.renderMessage({element:t},this.area,null,e)})),a){const e=a;this.view.renderMessage({element:e},this.area)}this.addCount()}))}addCount(){this.counters.forEach((e=>{e.innerHTML=this.view[e.id]}))}showPanel(){const e=new a;this.container.appendChild(e.element),e.element.querySelector(".close").addEventListener("click",(()=>{e.element.remove()})),e.addHooks(),this.panelEvents(e)}panelEvents(e){e.inputBtn.addEventListener("click",(()=>{e.overlapped.dispatchEvent(new MouseEvent("click"))})),e.inputBtn.addEventListener("change",(()=>{const t=e.overlapped.files&&e.overlapped.files[0];t&&this.fileView.read(t,((t,s)=>{this.api.sendMessage(null,s,t),e.element.remove()}))}))}}const r=document.querySelector(".widget");new l(r).init()})();